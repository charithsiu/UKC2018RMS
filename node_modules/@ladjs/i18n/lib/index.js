'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

var _require = require('path');

const extname = _require.extname,
      resolve = _require.resolve;

const isEmpty = require('lodash.isempty');
const sortBy = require('lodash.sortby');
const every = require('lodash.every');

var _require2 = require('qs');

const stringify = _require2.stringify;

const Boom = require('boom');
const s = require('underscore.string');

var _require3 = require('country-language');

const getLanguage = _require3.getLanguage;

const moment = require('moment');
const i18n = require('i18n');
const locales = require('i18n-locales');
const autoBind = require('auto-bind');

// expose global
i18n.api = {};

class I18N {
  constructor(config = {}) {
    this.config = Object.assign({
      phrases: {},
      logger: console,
      directory: resolve('locales'),
      locales: ['en', 'es', 'zh'],
      cookie: 'locale',
      indent: '  ',
      defaultLocale: 'en',
      syncFiles: true,
      autoReload: true,
      updateFiles: true,
      api: {
        __: 't',
        __n: 'tn',
        __l: 'tl',
        __h: 'th',
        __mf: 'tmf'
      },
      register: i18n.api
    }, config);

    const logger = this.config.logger;


    this.config.logDebugFn = logger.debug;
    this.config.logWarnFn = logger.warn;
    this.config.logErrorFn = logger.error;

    // validate locales against available ones
    if (!every(this.config.locales, l => locales.includes(l))) throw new Error(`Invalid locales: ${this.config.locales.filter(str => !locales.includes(str)).join(', ')}`);

    // inherit i18n object
    Object.assign(this, i18n);

    // configure i18n
    this.configure(this.config);

    autoBind(this);
  }

  translate(key, locale) {
    var _config = this.config;
    const logger = _config.logger,
          phrases = _config.phrases;

    let args = Object.keys(arguments).map(key => arguments[key]).slice(2);
    if (typeof args === 'undefined') args = [];
    const phrase = phrases[key];
    if (typeof phrase !== 'string') {
      logger.warn(`translation key missing: ${key}`);
      return;
    }
    args = [{ phrase, locale }, ...args];
    return i18n.api.t(...args);
  }

  middleware(ctx, next) {
    var _config2 = this.config;
    const locales = _config2.locales,
          defaultLocale = _config2.defaultLocale,
          phrases = _config2.phrases,
          cookie = _config2.cookie;

    // expose api methods to `ctx.req` and `ctx.state`

    i18n.init(ctx.req, ctx.state);

    // override the existing locale detection with our own
    // in order of priority:
    //
    // 1. check the URL, if === `/de` or starts with `/de/` then locale is `de`
    // 2. check the cookie
    // 3. check Accept-Language last
    //
    // also we need to expose `ctx.pathWithoutLocale`
    // as the path without locale

    let locale = locales.find(l => {
      return `/${l}` === ctx.path || ctx.path.indexOf(`/${l}/`) === 0;
    });

    ctx.pathWithoutLocale = locale ? ctx.path.substring(`/${locale}`.length) : ctx.path;
    if (ctx.pathWithoutLocale === '') ctx.pathWithoutLocale = '/';

    if (!locale) {
      locale = defaultLocale;
      if (ctx.cookies.get(cookie) && locales.includes(ctx.cookies.get(cookie))) locale = ctx.cookies.get(cookie);else if (ctx.request.acceptsLanguages(locales)) locale = ctx.request.acceptsLanguages(locales);
    }

    // set the locale properly
    i18n.setLocale([ctx.req, ctx.state], locale);

    // if the locale was not available then redirect user
    if (locale !== ctx.state.locale) return ctx.redirect(`/${ctx.state.locale}${ctx.pathWithoutLocale}${isEmpty(ctx.query) ? '' : `?${stringify(ctx.query)}`}`);

    // available languages for a dropdown menu to change language
    ctx.state.availableLanguages = sortBy(locales.map(locale => {
      return {
        locale,
        url: `/${locale}${ctx.pathWithoutLocale}${isEmpty(ctx.query) ? '' : `?${stringify(ctx.query)}`}`,
        name: getLanguage(locale).name[0]
      };
    }), 'name');

    // get the name of the current locale's language in native language
    ctx.state.currentLanguage = s.titleize(getLanguage(ctx.req.locale).nativeName[0]);

    // bind `ctx.translate` as a helper func
    // so you can pass `ctx.translate('SOME_KEY_IN_CONFIG');` and it will lookup
    // `phrases['SOMETHING']` to get a specific and constant message
    // and then it will call `t` to translate it to the user's locale
    ctx.translate = function () {
      if (typeof arguments[0] !== 'string' || typeof phrases[arguments[0]] !== 'string') return ctx.throw(Boom.badRequest('Translation for your locale failed, try again'));
      arguments[0] = phrases[arguments[0]];
      return ctx.req.t(...arguments);
    };

    return next();
  }

  redirect(ctx, next) {
    var _this = this;

    return _asyncToGenerator(function* () {
      // do not redirect static paths
      if (extname(ctx.path) !== '') return next();

      // inspired by nodejs.org language support
      // <https://github.com/nodejs/nodejs.org/commit/d6cdd942a8fc0fffcf6879eca124295e95991bbc#diff-78c12f5adc1848d13b1c6f07055d996eR59>
      const locale = ctx.url.split('/')[1].split('?')[0];
      const hasLang = _this.config.locales.includes(locale);

      // if the URL did not have a valid language found
      // then redirect the user to their detected locale
      if (!hasLang) {
        ctx.status = 302;
        let redirect = `/${ctx.req.locale}${ctx.url}`;
        if (!isEmpty(ctx.query)) redirect += `?${stringify(ctx.query)}`;
        return ctx.redirect(redirect);
      }

      // set the cookie for future requests
      ctx.cookies.set(_this.config.cookie, locale, {
        signed: true,
        expires: moment().add(1, 'year').toDate()
      });

      // if the user is logged in, then save it as `last_locale`
      if (ctx.isAuthenticated()) {
        ctx.state.user.last_locale = locale;
        try {
          yield ctx.state.user.save();
        } catch (err) {
          _this.config.logger.error(err);
        }
      }

      return next();
    })();
  }
}

module.exports = I18N;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJyZXF1aXJlIiwiZXh0bmFtZSIsInJlc29sdmUiLCJpc0VtcHR5Iiwic29ydEJ5IiwiZXZlcnkiLCJzdHJpbmdpZnkiLCJCb29tIiwicyIsImdldExhbmd1YWdlIiwibW9tZW50IiwiaTE4biIsImxvY2FsZXMiLCJhdXRvQmluZCIsImFwaSIsIkkxOE4iLCJjb25zdHJ1Y3RvciIsImNvbmZpZyIsIk9iamVjdCIsImFzc2lnbiIsInBocmFzZXMiLCJsb2dnZXIiLCJjb25zb2xlIiwiZGlyZWN0b3J5IiwiY29va2llIiwiaW5kZW50IiwiZGVmYXVsdExvY2FsZSIsInN5bmNGaWxlcyIsImF1dG9SZWxvYWQiLCJ1cGRhdGVGaWxlcyIsIl9fIiwiX19uIiwiX19sIiwiX19oIiwiX19tZiIsInJlZ2lzdGVyIiwibG9nRGVidWdGbiIsImRlYnVnIiwibG9nV2FybkZuIiwid2FybiIsImxvZ0Vycm9yRm4iLCJlcnJvciIsImwiLCJpbmNsdWRlcyIsIkVycm9yIiwiZmlsdGVyIiwic3RyIiwiam9pbiIsImNvbmZpZ3VyZSIsInRyYW5zbGF0ZSIsImtleSIsImxvY2FsZSIsImFyZ3MiLCJrZXlzIiwiYXJndW1lbnRzIiwibWFwIiwic2xpY2UiLCJwaHJhc2UiLCJ0IiwibWlkZGxld2FyZSIsImN0eCIsIm5leHQiLCJpbml0IiwicmVxIiwic3RhdGUiLCJmaW5kIiwicGF0aCIsImluZGV4T2YiLCJwYXRoV2l0aG91dExvY2FsZSIsInN1YnN0cmluZyIsImxlbmd0aCIsImNvb2tpZXMiLCJnZXQiLCJyZXF1ZXN0IiwiYWNjZXB0c0xhbmd1YWdlcyIsInNldExvY2FsZSIsInJlZGlyZWN0IiwicXVlcnkiLCJhdmFpbGFibGVMYW5ndWFnZXMiLCJ1cmwiLCJuYW1lIiwiY3VycmVudExhbmd1YWdlIiwidGl0bGVpemUiLCJuYXRpdmVOYW1lIiwidGhyb3ciLCJiYWRSZXF1ZXN0Iiwic3BsaXQiLCJoYXNMYW5nIiwic3RhdHVzIiwic2V0Iiwic2lnbmVkIiwiZXhwaXJlcyIsImFkZCIsInRvRGF0ZSIsImlzQXV0aGVudGljYXRlZCIsInVzZXIiLCJsYXN0X2xvY2FsZSIsInNhdmUiLCJlcnIiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O2VBQTZCQSxRQUFRLE1BQVIsQzs7TUFBckJDLE8sWUFBQUEsTztNQUFTQyxPLFlBQUFBLE87O0FBQ2pCLE1BQU1DLFVBQVVILFFBQVEsZ0JBQVIsQ0FBaEI7QUFDQSxNQUFNSSxTQUFTSixRQUFRLGVBQVIsQ0FBZjtBQUNBLE1BQU1LLFFBQVFMLFFBQVEsY0FBUixDQUFkOztnQkFDc0JBLFFBQVEsSUFBUixDOztNQUFkTSxTLGFBQUFBLFM7O0FBQ1IsTUFBTUMsT0FBT1AsUUFBUSxNQUFSLENBQWI7QUFDQSxNQUFNUSxJQUFJUixRQUFRLG1CQUFSLENBQVY7O2dCQUN3QkEsUUFBUSxrQkFBUixDOztNQUFoQlMsVyxhQUFBQSxXOztBQUNSLE1BQU1DLFNBQVNWLFFBQVEsUUFBUixDQUFmO0FBQ0EsTUFBTVcsT0FBT1gsUUFBUSxNQUFSLENBQWI7QUFDQSxNQUFNWSxVQUFVWixRQUFRLGNBQVIsQ0FBaEI7QUFDQSxNQUFNYSxXQUFXYixRQUFRLFdBQVIsQ0FBakI7O0FBRUE7QUFDQVcsS0FBS0csR0FBTCxHQUFXLEVBQVg7O0FBRUEsTUFBTUMsSUFBTixDQUFXO0FBQ1RDLGNBQVlDLFNBQVMsRUFBckIsRUFBeUI7QUFDdkIsU0FBS0EsTUFBTCxHQUFjQyxPQUFPQyxNQUFQLENBQ1o7QUFDRUMsZUFBUyxFQURYO0FBRUVDLGNBQVFDLE9BRlY7QUFHRUMsaUJBQVdyQixRQUFRLFNBQVIsQ0FIYjtBQUlFVSxlQUFTLENBQUMsSUFBRCxFQUFPLElBQVAsRUFBYSxJQUFiLENBSlg7QUFLRVksY0FBUSxRQUxWO0FBTUVDLGNBQVEsSUFOVjtBQU9FQyxxQkFBZSxJQVBqQjtBQVFFQyxpQkFBVyxJQVJiO0FBU0VDLGtCQUFZLElBVGQ7QUFVRUMsbUJBQWEsSUFWZjtBQVdFZixXQUFL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QTZCUSxNQUE3QixDQUFoQjs7QUFFQTtBQUNBO0FBQ0EsVUFBSSxDQUFDb0MsT0FBTCxFQUFjO0FBQ1ozQixZQUFJNEIsTUFBSixHQUFhLEdBQWI7QUFDQSxZQUFJWixXQUFZLElBQUdoQixJQUFJRyxHQUFKLENBQVFaLE1BQU8sR0FBRVMsSUFBSW1CLEdBQUksRUFBNUM7QUFDQSxZQUFJLENBQUM1RSxRQUFReUQsSUFBSWlCLEtBQVosQ0FBTCxFQUF5QkQsWUFBYSxJQUFHdEUsVUFBVXNELElBQUlpQixLQUFkLENBQXFCLEVBQXJDO0FBQ3pCLGVBQU9qQixJQUFJZ0IsUUFBSixDQUFhQSxRQUFiLENBQVA7QUFDRDs7QUFFRDtBQUNBaEIsVUFBSVcsT0FBSixDQUFZa0IsR0FBWixDQUFnQixNQUFLeEUsTUFBTCxDQUFZTyxNQUE1QixFQUFvQzJCLE1BQXBDLEVBQTRDO0FBQzFDdUMsZ0JBQVEsSUFEa0M7QUFFMUNDLGlCQUFTakYsU0FDTmtGLEdBRE0sQ0FDRixDQURFLEVBQ0MsTUFERCxFQUVOQyxNQUZNO0FBRmlDLE9BQTVDOztBQU9BO0FBQ0EsVUFBSWpDLElBQUlrQyxlQUFKLEVBQUosRUFBMkI7QUFDekJsQyxZQUFJSSxLQUFKLENBQVUrQixJQUFWLENBQWVDLFdBQWYsR0FBNkI3QyxNQUE3QjtBQUNBLFlBQUk7QUFDRixnQkFBTVMsSUFBSUksS0FBSixDQUFVK0IsSUFBVixDQUFlRSxJQUFmLEVBQU47QUFDRCxTQUZELENBRUUsT0FBT0MsR0FBUCxFQUFZO0FBQ1osZ0JBQUtqRixNQUFMLENBQVlJLE1BQVosQ0FBbUJvQixLQUFuQixDQUF5QnlELEdBQXpCO0FBQ0Q7QUFDRjs7QUFFRCxhQUFPckMsTUFBUDtBQXBDd0I7QUFxQ3pCO0FBdkxROztBQTBMWHNDLE9BQU9DLE9BQVAsR0FBaUJyRixJQUFqQiIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgZXh0bmFtZSwgcmVzb2x2ZSB9ID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgaXNFbXB0eSA9IHJlcXVpcmUoJ2xvZGFzaC5pc2VtcHR5Jyk7XG5jb25zdCBzb3J0QnkgPSByZXF1aXJlKCdsb2Rhc2guc29ydGJ5Jyk7XG5jb25zdCBldmVyeSA9IHJlcXVpcmUoJ2xvZGFzaC5ldmVyeScpO1xuY29uc3QgeyBzdHJpbmdpZnkgfSA9IHJlcXVpcmUoJ3FzJyk7XG5jb25zdCBCb29tID0gcmVxdWlyZSgnYm9vbScpO1xuY29uc3QgcyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUuc3RyaW5nJyk7XG5jb25zdCB7IGdldExhbmd1YWdlIH0gPSByZXF1aXJlKCdjb3VudHJ5LWxhbmd1YWdlJyk7XG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcbmNvbnN0IGkxOG4gPSByZXF1aXJlKCdpMThuJyk7XG5jb25zdCBsb2NhbGVzID0gcmVxdWlyZSgnaTE4bi1sb2NhbGVzJyk7XG5jb25zdCBhdXRvQmluZCA9IHJlcXVpcmUoJ2F1dG8tYmluZCcpO1xuXG4vLyBleHBvc2UgZ2xvYmFsXG5pMThuLmFwaSA9IHt9O1xuXG5jbGFzcyBJMThOIHtcbiAgY29uc3RydWN0b3IoY29uZmlnID0ge30pIHtcbiAgICB0aGlzLmNvbmZpZyA9IE9iamVjdC5hc3NpZ24oXG4gICAgICB7XG4gICAgICAgIHBocmFzZXM6IHt9LFxuICAgICAgICBsb2dnZXI6IGNvbnNvbGUsXG4gICAgICAgIGRpcmVjdG9yeTogcmVzb2x2ZSgnbG9jYWxlcycpLFxuICAgICAgICBsb2NhbGVzOiBbJ2VuJywgJ2VzJywgJ3poJ10sXG4gICAgICAgIGNvb2tpZTogJ2xvY2FsZScsXG4gICAgICAgIGluZGVudDogJyAgJyxcbiAgICAgICAgZGVmYXVsdExvY2FsZTogJ2VuJyxcbiAgICAgICAgc3luY0ZpbGVzOiB0cnVlLFxuICAgICAgICBhdXRvUmVsb2FkOiB0cnVlLFxuICAgICAgICB1cGRhdGVGaWxlczogdHJ1ZSxcbiAgICAgICAgYXBpOiB7XG4gICAgICAgICAgX186ICd0JyxcbiAgICAgICAgICBfX246ICd0bicsXG4gICAgICAgICAgX19sOiAndGwnLFxuICAgICAgICAgIF9faDogJ3RoJyxcbiAgICAgICAgICBfX21mOiAndG1mJ1xuICAgICAgICB9LFxuICAgICAgICByZWdpc3RlcjogaTE4bi5hcGlcbiAgICAgIH0sXG4gICAgICBjb25maWdcbiAgICApO1xuXG4gICAgY29uc3QgeyBsb2dnZXIgfSA9IHRoaXMuY29uZmlnO1xuXG4gICAgdGhpcy5jb25maWcubG9nRGVidWdGbiA9IGxvZ2dlci5kZWJ1ZztcbiAgICB0aGlzLmNvbmZpZy5sb2dXYXJuRm4gPSBsb2dnZXIud2FybjtcbiAgICB0aGlzLmNvbmZpZy5sb2dFcnJvckZuID0gbG9nZ2VyLmVycm9yO1xuXG4gICAgLy8gdmFsaWRhdGUgbG9jYWxlcyBhZ2FpbnN0IGF2YWlsYWJsZSBvbmVzXG4gICAgaWYgKCFldmVyeSh0aGlzLmNvbmZpZy5sb2NhbGVzLCBsID0+IGxvY2FsZXMuaW5jbHVkZXMobCkpKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBgSW52YWxpZCBsb2NhbGVzOiAke3RoaXMuY29uZmlnLmxvY2FsZXNcbiAgICAgICAgICAuZmlsdGVyKHN0ciA9PiAhbG9jYWxlcy5pbmNsdWRlcyhzdHIpKVxuICAgICAgICAgIC5qb2luKCcsICcpfWBcbiAgICAgICk7XG5cbiAgICAvLyBpbmhlcml0IGkxOG4gb2JqZWN0XG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLCBpMThuKTtcblxuICAgIC8vIGNvbmZpZ3VyZSBpMThuXG4gICAgdGhpcy5jb25maWd1cmUodGhpcy5jb25maWcpO1xuXG4gICAgYXV0b0JpbmQodGhpcyk7XG4gIH1cblxuICB0cmFuc2xhdGUoa2V5LCBsb2NhbGUpIHtcbiAgICBjb25zdCB7IGxvZ2dlciwgcGhyYXNlcyB9ID0gdGhpcy5jb25maWc7XG4gICAgbGV0IGFyZ3MgPSBPYmplY3Qua2V5cyhhcmd1bWVudHMpXG4gICAgICAubWFwKGtleSA9PiBhcmd1bWVudHNba2V5XSlcbiAgICAgIC5zbGljZSgyKTtcbiAgICBpZiAodHlwZW9mIGFyZ3MgPT09ICd1bmRlZmluZWQnKSBhcmdzID0gW107XG4gICAgY29uc3QgcGhyYXNlID0gcGhyYXNlc1trZXldO1xuICAgIGlmICh0eXBlb2YgcGhyYXNlICE9PSAnc3RyaW5nJykge1xuICAgICAgbG9nZ2VyLndhcm4oYHRyYW5zbGF0aW9uIGtleSBtaXNzaW5nOiAke2tleX1gKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXJncyA9IFt7IHBocmFzZSwgbG9jYWxlIH0sIC4uLmFyZ3NdO1xuICAgIHJldHVybiBpMThuLmFwaS50KC4uLmFyZ3MpO1xuICB9XG5cbiAgbWlkZGxld2FyZShjdHgsIG5leHQpIHtcbiAgICBjb25zdCB7IGxvY2FsZXMsIGRlZmF1bHRMb2NhbGUsIHBocmFzZXMsIGNvb2tpZSB9ID0gdGhpcy5jb25maWc7XG5cbiAgICAvLyBleHBvc2UgYXBpIG1ldGhvZHMgdG8gYGN0eC5yZXFgIGFuZCBgY3R4LnN0YXRlYFxuICAgIGkxOG4uaW5pdChjdHgucmVxLCBjdHguc3RhdGUpO1xuXG4gICAgLy8gb3ZlcnJpZGUgdGhlIGV4aXN0aW5nIGxvY2FsZSBkZXRlY3Rpb24gd2l0aCBvdXIgb3duXG4gICAgLy8gaW4gb3JkZXIgb2YgcHJpb3JpdHk6XG4gICAgLy9cbiAgICAvLyAxLiBjaGVjayB0aGUgVVJMLCBpZiA9PT0gYC9kZWAgb3Igc3RhcnRzIHdpdGggYC9kZS9gIHRoZW4gbG9jYWxlIGlzIGBkZWBcbiAgICAvLyAyLiBjaGVjayB0aGUgY29va2llXG4gICAgLy8gMy4gY2hlY2sgQWNjZXB0LUxhbmd1YWdlIGxhc3RcbiAgICAvL1xuICAgIC8vIGFsc28gd2UgbmVlZCB0byBleHBvc2UgYGN0eC5wYXRoV2l0aG91dExvY2FsZWBcbiAgICAvLyBhcyB0aGUgcGF0aCB3aXRob3V0IGxvY2FsZVxuXG4gICAgbGV0IGxvY2FsZSA9IGxvY2FsZXMuZmluZChsID0+IHtcbiAgICAgIHJldHVybiBgLyR7bH1gID09PSBjdHgucGF0aCB8fCBjdHgucGF0aC5pbmRleE9mKGAvJHtsfS9gKSA9PT0gMDtcbiAgICB9KTtcblxuICAgIGN0eC5wYXRoV2l0aG91dExvY2FsZSA9IGxvY2FsZVxuICAgICAgPyBjdHgucGF0aC5zdWJzdHJpbmcoYC8ke2xvY2FsZX1gLmxlbmd0aClcbiAgICAgIDogY3R4LnBhdGg7XG4gICAgaWYgKGN0eC5wYXRoV2l0aG91dExvY2FsZSA9PT0gJycpIGN0eC5wYXRoV2l0aG91dExvY2FsZSA9ICcvJztcblxuICAgIGlmICghbG9jYWxlKSB7XG4gICAgICBsb2NhbGUgPSBkZWZhdWx0TG9jYWxlO1xuICAgICAgaWYgKGN0eC5jb29raWVzLmdldChjb29raWUpICYmIGxvY2FsZXMuaW5jbHVkZXMoY3R4LmNvb2tpZXMuZ2V0KGNvb2tpZSkpKVxuICAgICAgICBsb2NhbGUgPSBjdHguY29va2llcy5nZXQoY29va2llKTtcbiAgICAgIGVsc2UgaWYgKGN0eC5yZXF1ZXN0LmFjY2VwdHNMYW5ndWFnZXMobG9jYWxlcykpXG4gICAgICAgIGxvY2FsZSA9IGN0eC5yZXF1ZXN0LmFjY2VwdHNMYW5ndWFnZXMobG9jYWxlcyk7XG4gICAgfVxuXG4gICAgLy8gc2V0IHRoZSBsb2NhbGUgcHJvcGVybHlcbiAgICBpMThuLnNldExvY2FsZShbY3R4LnJlcSwgY3R4LnN0YXRlXSwgbG9jYWxlKTtcblxuICAgIC8vIGlmIHRoZSBsb2NhbGUgd2FzIG5vdCBhdmFpbGFibGUgdGhlbiByZWRpcmVjdCB1c2VyXG4gICAgaWYgKGxvY2FsZSAhPT0gY3R4LnN0YXRlLmxvY2FsZSlcbiAgICAgIHJldHVybiBjdHgucmVkaXJlY3QoXG4gICAgICAgIGAvJHtjdHguc3RhdGUubG9jYWxlfSR7Y3R4LnBhdGhXaXRob3V0TG9jYWxlfSR7aXNFbXB0eShjdHgucXVlcnkpXG4gICAgICAgICAgPyAnJ1xuICAgICAgICAgIDogYD8ke3N0cmluZ2lmeShjdHgucXVlcnkpfWB9YFxuICAgICAgKTtcblxuICAgIC8vIGF2YWlsYWJsZSBsYW5ndWFnZXMgZm9yIGEgZHJvcGRvd24gbWVudSB0byBjaGFuZ2UgbGFuZ3VhZ2VcbiAgICBjdHguc3RhdGUuYXZhaWxhYmxlTGFuZ3VhZ2VzID0gc29ydEJ5KFxuICAgICAgbG9jYWxlcy5tYXAobG9jYWxlID0+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBsb2NhbGUsXG4gICAgICAgICAgdXJsOiBgLyR7bG9jYWxlfSR7Y3R4LnBhdGhXaXRob3V0TG9jYWxlfSR7aXNFbXB0eShjdHgucXVlcnkpXG4gICAgICAgICAgICA/ICcnXG4gICAgICAgICAgICA6IGA/JHtzdHJpbmdpZnkoY3R4LnF1ZXJ5KX1gfWAsXG4gICAgICAgICAgbmFtZTogZ2V0TGFuZ3VhZ2UobG9jYWxlKS5uYW1lWzBdXG4gICAgICAgIH07XG4gICAgICB9KSxcbiAgICAgICduYW1lJ1xuICAgICk7XG5cbiAgICAvLyBnZXQgdGhlIG5hbWUgb2YgdGhlIGN1cnJlbnQgbG9jYWxlJ3MgbGFuZ3VhZ2UgaW4gbmF0aXZlIGxhbmd1YWdlXG4gICAgY3R4LnN0YXRlLmN1cnJlbnRMYW5ndWFnZSA9IHMudGl0bGVpemUoXG4gICAgICBnZXRMYW5ndWFnZShjdHgucmVxLmxvY2FsZSkubmF0aXZlTmFtZVswXVxuICAgICk7XG5cbiAgICAvLyBiaW5kIGBjdHgudHJhbnNsYXRlYCBhcyBhIGhlbHBlciBmdW5jXG4gICAgLy8gc28geW91IGNhbiBwYXNzIGBjdHgudHJhbnNsYXRlKCdTT01FX0tFWV9JTl9DT05GSUcnKTtgIGFuZCBpdCB3aWxsIGxvb2t1cFxuICAgIC8vIGBwaHJhc2VzWydTT01FVEhJTkcnXWAgdG8gZ2V0IGEgc3BlY2lmaWMgYW5kIGNvbnN0YW50IG1lc3NhZ2VcbiAgICAvLyBhbmQgdGhlbiBpdCB3aWxsIGNhbGwgYHRgIHRvIHRyYW5zbGF0ZSBpdCB0byB0aGUgdXNlcidzIGxvY2FsZVxuICAgIGN0eC50cmFuc2xhdGUgPSBmdW5jdGlvbigpIHtcbiAgICAgIGlmIChcbiAgICAgICAgdHlwZW9mIGFyZ3VtZW50c1swXSAhPT0gJ3N0cmluZycgfHxcbiAgICAgICAgdHlwZW9mIHBocmFzZXNbYXJndW1lbnRzWzBdXSAhPT0gJ3N0cmluZydcbiAgICAgIClcbiAgICAgICAgcmV0dXJuIGN0eC50aHJvdyhcbiAgICAgICAgICBCb29tLmJhZFJlcXVlc3QoJ1RyYW5zbGF0aW9uIGZvciB5b3VyIGxvY2FsZSBmYWlsZWQsIHRyeSBhZ2FpbicpXG4gICAgICAgICk7XG4gICAgICBhcmd1bWVudHNbMF0gPSBwaHJhc2VzW2FyZ3VtZW50c1swXV07XG4gICAgICByZXR1cm4gY3R4LnJlcS50KC4uLmFyZ3VtZW50cyk7XG4gICAgfTtcblxuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cblxuICBhc3luYyByZWRpcmVjdChjdHgsIG5leHQpIHtcbiAgICAvLyBkbyBub3QgcmVkaXJlY3Qgc3RhdGljIHBhdGhzXG4gICAgaWYgKGV4dG5hbWUoY3R4LnBhdGgpICE9PSAnJykgcmV0dXJuIG5leHQoKTtcblxuICAgIC8vIGluc3BpcmVkIGJ5IG5vZGVqcy5vcmcgbGFuZ3VhZ2Ugc3VwcG9ydFxuICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGVqcy5vcmcvY29tbWl0L2Q2Y2RkOTQyYThmYzBmZmZjZjY4NzllY2ExMjQyOTVlOTU5OTFiYmMjZGlmZi03OGMxMmY1YWRjMTg0OGQxM2IxYzZmMDcwNTVkOTk2ZVI1OT5cbiAgICBjb25zdCBsb2NhbGUgPSBjdHgudXJsLnNwbGl0KCcvJylbMV0uc3BsaXQoJz8nKVswXTtcbiAgICBjb25zdCBoYXNMYW5nID0gdGhpcy5jb25maWcubG9jYWxlcy5pbmNsdWRlcyhsb2NhbGUpO1xuXG4gICAgLy8gaWYgdGhlIFVSTCBkaWQgbm90IGhhdmUgYSB2YWxpZCBsYW5ndWFnZSBmb3VuZFxuICAgIC8vIHRoZW4gcmVkaXJlY3QgdGhlIHVzZXIgdG8gdGhlaXIgZGV0ZWN0ZWQgbG9jYWxlXG4gICAgaWYgKCFoYXNMYW5nKSB7XG4gICAgICBjdHguc3RhdHVzID0gMzAyO1xuICAgICAgbGV0IHJlZGlyZWN0ID0gYC8ke2N0eC5yZXEubG9jYWxlfSR7Y3R4LnVybH1gO1xuICAgICAgaWYgKCFpc0VtcHR5KGN0eC5xdWVyeSkpIHJlZGlyZWN0ICs9IGA/JHtzdHJpbmdpZnkoY3R4LnF1ZXJ5KX1gO1xuICAgICAgcmV0dXJuIGN0eC5yZWRpcmVjdChyZWRpcmVjdCk7XG4gICAgfVxuXG4gICAgLy8gc2V0IHRoZSBjb29raWUgZm9yIGZ1dHVyZSByZXF1ZXN0c1xuICAgIGN0eC5jb29raWVzLnNldCh0aGlzLmNvbmZpZy5jb29raWUsIGxvY2FsZSwge1xuICAgICAgc2lnbmVkOiB0cnVlLFxuICAgICAgZXhwaXJlczogbW9tZW50KClcbiAgICAgICAgLmFkZCgxLCAneWVhcicpXG4gICAgICAgIC50b0RhdGUoKVxuICAgIH0pO1xuXG4gICAgLy8gaWYgdGhlIHVzZXIgaXMgbG9nZ2VkIGluLCB0aGVuIHNhdmUgaXQgYXMgYGxhc3RfbG9jYWxlYFxuICAgIGlmIChjdHguaXNBdXRoZW50aWNhdGVkKCkpIHtcbiAgICAgIGN0eC5zdGF0ZS51c2VyLmxhc3RfbG9jYWxlID0gbG9jYWxlO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgY3R4LnN0YXRlLnVzZXIuc2F2ZSgpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMuY29uZmlnLmxvZ2dlci5lcnJvcihlcnIpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBuZXh0KCk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBJMThOO1xuIl19