'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const path = require('path');
const debug = require('debug')('email-templates');
const fs = require('fs-extra');
const htmlToText = require('html-to-text');
const I18N = require('@ladjs/i18n');
const autoBind = require('auto-bind');
const nodemailer = require('nodemailer');
const consolidate = require('consolidate');
const isFunction = require('lodash.isfunction');
const isObject = require('lodash.isobject');
const isEmpty = require('lodash.isempty');
const isString = require('lodash.isstring');
const omit = require('lodash.omit');
const defaultsDeep = require('lodash.defaultsdeep');
const merge = require('lodash.merge');
const previewEmail = require('preview-email');

const getPaths = require('get-paths');
const juiceResources = require('juice-resources-promise');

class Email {
  constructor(config = {}) {
    debug('config passed %O', config);

    // 2.x backwards compatible support
    if (config.juiceOptions) {
      config.juiceResources = config.juiceOptions;
      delete config.juiceOptions;
    }
    if (config.disableJuice) {
      config.juice = false;
      delete config.disableJuice;
    }

    this.config = merge({
      views: {
        // directory where email templates reside
        root: path.resolve('emails'),
        options: {
          // default file extension for template
          extension: 'pug',
          map: {},
          engineSource: consolidate
        },
        // locals to pass to templates for rendering
        locals: {
          // pretty is automatically set to `false` for subject/text
          pretty: true
        }
      },
      // <https://nodemailer.com/message/>
      message: {},
      send: !['development', 'test'].includes(process.env.NODE_ENV),
      preview: process.env.NODE_ENV === 'development',
      // <https://github.com/ladjs/i18n>
      // set to an object to configure and enable it
      i18n: false,
      // pass a custom render function if necessary
      render: this.render.bind(this),
      // <https://github.com/werk85/node-html-to-text>
      htmlToText: {
        ignoreImage: true
      },
      // <https://github.com/Automattic/juice>
      juice: true,
      juiceResources: {
        preserveImportant: true,
        webResources: {
          relativeTo: path.resolve('build')
        }
      },
      // pass a transport configuration object or a transport instance
      // (e.g. an instance is created via `nodemailer.createTransport`)
      // <https://nodemailer.com/transports/>
      transport: {}
    }, config);

    if (!isObject(this.config.transport) || isEmpty(this.config.transport)) throw new Error('Transport option must be a transport instance or configuration object');

    if (!isFunction(this.config.transport.sendMail)) this.config.transport = nodemailer.createTransport(this.config.transport);

    debug('transformed config %O', this.config);

    autoBind(this);
  }

  // shorthand use of `juiceResources` with the config
  // (mainly for custom renders like from a database)
  juiceResources(html) {
    return juiceResources(html, this.config.juiceResources);
  }

  // promise version of consolidate's render
  // inspired by koa-views and re-uses the same config
  // <https://github.com/queckezz/koa-views>
  render(view, locals) {
    var _this = this;

    return new Promise((() => {
      var _ref = _asyncToGenerator(function* (resolve, reject) {
        try {
          var _config$views$options = _this.config.views.options;
          const map = _config$views$options.map,
                engineSource = _config$views$options.engineSource,
                extension = _config$views$options.extension;

          const paths = yield getPaths(_this.config.views.root, view, extension);
          const filePath = path.resolve(_this.config.views.root, paths.rel);
          const suffix = paths.ext;
          if (suffix === 'html' && !map) {
            const res = yield fs.readFile(filePath, 'utf8');
            resolve(res);
          } else {
            const engineName = map && map[suffix] ? map[suffix] : suffix;
            const render = engineSource[engineName];
            if (!engineName || !render) return reject(new Error(`Engine not found for the ".${suffix}" file extension`));
            // TODO: convert this to a promise based version
            render(filePath, locals, function (err, res) {
              if (err) return reject(err);
              // transform the html with juice using remote paths
              // google now supports media queries
              // https://developers.google.com/gmail/design/reference/supported_css
              if (!_this.config.juice) return resolve(res);
              _this.juiceResources(res).then(resolve).catch(reject);
            });
          }
        } catch (err) {
          reject(err);
        }
      });

      return function (_x, _x2) {
        return _ref.apply(this, arguments);
      };
    })());
  }

  send(options = {}) {
    var _this2 = this;

    options = Object.assign({
      template: '',
      message: {},
      locals: {}
    }, options);

    var _options = options;
    let template = _options.template,
        message = _options.message,
        locals = _options.locals;


    const attachments = message.attachments || this.config.message.attachments || [];

    message = defaultsDeep({}, omit(this.config.message, 'attachments'), omit(message, 'attachments'));
    locals = defaultsDeep({}, this.config.views.locals, locals);

    if (attachments) message.attachments = attachments;

    debug('template %s', template);
    debug('message %O', message);
    debug('locals (keys only): %O', Object.keys(locals));

    return new Promise((() => {
      var _ref2 = _asyncToGenerator(function* (resolve, reject) {
        try {
          if (isObject(_this2.config.i18n)) {
            const i18n = new I18N(Object.assign({}, _this2.config.i18n, {
              register: locals
            }));

            // support `locals.user.last_locale`
            // (e.g. for <https://lad.js.org>)
            if (isObject(locals.user) && isString(locals.user.last_locale)) locals.locale = locals.user.last_locale;

            if (isString(locals.locale)) i18n.setLocale(locals.locale);
          }

          if (!message.subject && template) message.subject = yield _this2.config.render(`${template}/subject`, Object.assign({}, locals, { pretty: false }));

          if (!message.html && template) message.html = yield _this2.config.render(`${template}/html`, locals);

          if (!_this2.config.htmlToText && !message.text && template) message.text = yield _this2.config.render(`${template}/text`, Object.assign({}, locals, { pretty: false }));else if (_this2.config.htmlToText && message.html)
            // we'd use nodemailer-html-to-text plugin
            // but we really don't need to support cid
            // <https://github.com/andris9/nodemailer-html-to-text>
            message.text = htmlToText.fromString(message.html, _this2.config.htmlToText);

          if (_this2.config.preview) {
            debug('using `preview-email` to preview email');
            yield previewEmail(message);
          }

          if (!_this2.config.send) {
            debug('send disabled so we are ensuring JSONTransport');
            // <https://github.com/nodemailer/nodemailer/issues/798>
            // if (this.config.transport.name !== 'JSONTransport')
            _this2.config.transport = nodemailer.createTransport({
              jsonTransport: true
            });
          }

          const res = yield _this2.config.transport.sendMail(message);
          debug('message sent');
          resolve(res);
        } catch (err) {
          reject(err);
        }
      });

      return function (_x3, _x4) {
        return _ref2.apply(this, arguments);
      };
    })());
  }
}

module.exports = Email;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJwYXRoIiwicmVxdWlyZSIsImRlYnVnIiwiZnMiLCJodG1sVG9UZXh0IiwiSTE4TiIsImF1dG9CaW5kIiwibm9kZW1haWxlciIsImNvbnNvbGlkYXRlIiwiaXNGdW5jdGlvbiIsImlzT2JqZWN0IiwiaXNFbXB0eSIsImlzU3RyaW5nIiwib21pdCIsImRlZmF1bHRzRGVlcCIsIm1lcmdlIiwicHJldmlld0VtYWlsIiwiZ2V0UGF0aHMiLCJqdWljZVJlc291cmNlcyIsIkVtYWlsIiwiY29uc3RydWN0b3IiLCJjb25maWciLCJqdWljZU9wdGlvbnMiLCJkaXNhYmxlSnVpY2UiLCJqdWljZSIsInZpZXdzIiwicm9vdCIsInJlc29sdmUiLCJvcHRpb25zIiwiZXh0ZW5zaW9uIiwibWFwIiwiZW5naW5lU291cmNlIiwibG9jYWxzIiwicHJldHR5IiwibWVzc2FnZSIsInNlbmQiLCJpbmNsdWRlcyIsInByb2Nlc3MiLCJlbnYiLCJOT0RFX0VOViIsInByZXZpZXciLCJpMThuIiwicmVuZGVyIiwiYmluZCIsImlnbm9yZUltYWdlIiwicHJlc2VydmVJbXBvcnRhbnQiLCJ3ZWJSZXNvdXJjZXMiLCJyZWxhdGl2ZVRvIiwidHJhbnNwb3J0IiwiRXJyb3IiLCJzZW5kTWFpbCIsImNyZWF0ZVRyYW5zcG9ydCIsImh0bWwiLCJ2aWV3IiwiUHJvbWlzZSIsInJlamVjdCIsInBhdGhzIiwiZmlsZVBhdGgiLCJyZWwiLCJzdWZmaXgiLCJleHQiLCJyZXMiLCJyZWFkRmlsZSIsImVuZ2luZU5hbWUiLCJlcnIiLCJ0aGVuIiwiY2F0Y2giLCJPYmplY3QiLCJhc3NpZ24iLCJ0ZW1wbGF0ZSIsImF0dGFjaG1lbnRzIiwia2V5cyIsInJlZ2lzdGVyIiwidXNlciIsImxhc3RfbG9jYWxlIiwibG9jYWxlIiwic2V0TG9jYWxlIiwic3ViamVjdCIsInRleHQiLCJmcm9tU3RyaW5nIiwianNvblRyYW5zcG9ydCIsIm1vZHVsZSIsImV4cG9y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Q0FBWTJCLFNBQVosR0FBd0J6QyxXQUFXNEMsZUFBWCxDQUEyQjtBQUNqRDZCLDZCQUFlO0FBRGtDLGFBQTNCLENBQXhCO0FBR0Q7O0FBRUQsZ0JBQU1uQixNQUFNLE1BQU0sT0FBS3hDLE1BQUwsQ0FBWTJCLFNBQVosQ0FBc0JFLFFBQXRCLENBQStCaEIsT0FBL0IsQ0FBbEI7QUFDQWhDLGdCQUFNLGNBQU47QUFDQXlCLGtCQUFRa0MsR0FBUjtBQUNELFNBeERELENBd0RFLE9BQU9HLEdBQVAsRUFBWTtBQUNaVCxpQkFBT1MsR0FBUDtBQUNEO0FBQ0YsT0E1RE07O0FBQUE7QUFBQTtBQUFBO0FBQUEsU0FBUDtBQTZERDtBQTlNUzs7QUFpTlppQixPQUFPQyxPQUFQLEdBQWlCL0QsS0FBakIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuY29uc3QgZGVidWcgPSByZXF1aXJlKCdkZWJ1ZycpKCdlbWFpbC10ZW1wbGF0ZXMnKTtcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmNvbnN0IGh0bWxUb1RleHQgPSByZXF1aXJlKCdodG1sLXRvLXRleHQnKTtcbmNvbnN0IEkxOE4gPSByZXF1aXJlKCdAbGFkanMvaTE4bicpO1xuY29uc3QgYXV0b0JpbmQgPSByZXF1aXJlKCdhdXRvLWJpbmQnKTtcbmNvbnN0IG5vZGVtYWlsZXIgPSByZXF1aXJlKCdub2RlbWFpbGVyJyk7XG5jb25zdCBjb25zb2xpZGF0ZSA9IHJlcXVpcmUoJ2NvbnNvbGlkYXRlJyk7XG5jb25zdCBpc0Z1bmN0aW9uID0gcmVxdWlyZSgnbG9kYXNoLmlzZnVuY3Rpb24nKTtcbmNvbnN0IGlzT2JqZWN0ID0gcmVxdWlyZSgnbG9kYXNoLmlzb2JqZWN0Jyk7XG5jb25zdCBpc0VtcHR5ID0gcmVxdWlyZSgnbG9kYXNoLmlzZW1wdHknKTtcbmNvbnN0IGlzU3RyaW5nID0gcmVxdWlyZSgnbG9kYXNoLmlzc3RyaW5nJyk7XG5jb25zdCBvbWl0ID0gcmVxdWlyZSgnbG9kYXNoLm9taXQnKTtcbmNvbnN0IGRlZmF1bHRzRGVlcCA9IHJlcXVpcmUoJ2xvZGFzaC5kZWZhdWx0c2RlZXAnKTtcbmNvbnN0IG1lcmdlID0gcmVxdWlyZSgnbG9kYXNoLm1lcmdlJyk7XG5jb25zdCBwcmV2aWV3RW1haWwgPSByZXF1aXJlKCdwcmV2aWV3LWVtYWlsJyk7XG5cbmNvbnN0IGdldFBhdGhzID0gcmVxdWlyZSgnZ2V0LXBhdGhzJyk7XG5jb25zdCBqdWljZVJlc291cmNlcyA9IHJlcXVpcmUoJ2p1aWNlLXJlc291cmNlcy1wcm9taXNlJyk7XG5cbmNsYXNzIEVtYWlsIHtcbiAgY29uc3RydWN0b3IoY29uZmlnID0ge30pIHtcbiAgICBkZWJ1ZygnY29uZmlnIHBhc3NlZCAlTycsIGNvbmZpZyk7XG5cbiAgICAvLyAyLnggYmFja3dhcmRzIGNvbXBhdGlibGUgc3VwcG9ydFxuICAgIGlmIChjb25maWcuanVpY2VPcHRpb25zKSB7XG4gICAgICBjb25maWcuanVpY2VSZXNvdXJjZXMgPSBjb25maWcuanVpY2VPcHRpb25zO1xuICAgICAgZGVsZXRlIGNvbmZpZy5qdWljZU9wdGlvbnM7XG4gICAgfVxuICAgIGlmIChjb25maWcuZGlzYWJsZUp1aWNlKSB7XG4gICAgICBjb25maWcuanVpY2UgPSBmYWxzZTtcbiAgICAgIGRlbGV0ZSBjb25maWcuZGlzYWJsZUp1aWNlO1xuICAgIH1cblxuICAgIHRoaXMuY29uZmlnID0gbWVyZ2UoXG4gICAgICB7XG4gICAgICAgIHZpZXdzOiB7XG4gICAgICAgICAgLy8gZGlyZWN0b3J5IHdoZXJlIGVtYWlsIHRlbXBsYXRlcyByZXNpZGVcbiAgICAgICAgICByb290OiBwYXRoLnJlc29sdmUoJ2VtYWlscycpLFxuICAgICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICAgIC8vIGRlZmF1bHQgZmlsZSBleHRlbnNpb24gZm9yIHRlbXBsYXRlXG4gICAgICAgICAgICBleHRlbnNpb246ICdwdWcnLFxuICAgICAgICAgICAgbWFwOiB7fSxcbiAgICAgICAgICAgIGVuZ2luZVNvdXJjZTogY29uc29saWRhdGVcbiAgICAgICAgICB9LFxuICAgICAgICAgIC8vIGxvY2FscyB0byBwYXNzIHRvIHRlbXBsYXRlcyBmb3IgcmVuZGVyaW5nXG4gICAgICAgICAgbG9jYWxzOiB7XG4gICAgICAgICAgICAvLyBwcmV0dHkgaXMgYXV0b21hdGljYWxseSBzZXQgdG8gYGZhbHNlYCBmb3Igc3ViamVjdC90ZXh0XG4gICAgICAgICAgICBwcmV0dHk6IHRydWVcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIC8vIDxodHRwczovL25vZGVtYWlsZXIuY29tL21lc3NhZ2UvPlxuICAgICAgICBtZXNzYWdlOiB7fSxcbiAgICAgICAgc2VuZDogIVsnZGV2ZWxvcG1lbnQnLCAndGVzdCddLmluY2x1ZGVzKHByb2Nlc3MuZW52Lk5PREVfRU5WKSxcbiAgICAgICAgcHJldmlldzogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcsXG4gICAgICAgIC8vIDxodHRwczovL2dpdGh1Yi5jb20vbGFkanMvaTE4bj5cbiAgICAgICAgLy8gc2V0IHRvIGFuIG9iamVjdCB0byBjb25maWd1cmUgYW5kIGVuYWJsZSBpdFxuICAgICAgICBpMThuOiBmYWxzZSxcbiAgICAgICAgLy8gcGFzcyBhIGN1c3RvbSByZW5kZXIgZnVuY3Rpb24gaWYgbmVjZXNzYXJ5XG4gICAgICAgIHJlbmRlcjogdGhpcy5yZW5kZXIuYmluZCh0aGlzKSxcbiAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS93ZXJrODUvbm9kZS1odG1sLXRvLXRleHQ+XG4gICAgICAgIGh0bWxUb1RleHQ6IHtcbiAgICAgICAgICBpZ25vcmVJbWFnZTogdHJ1ZVxuICAgICAgICB9LFxuICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL0F1dG9tYXR0aWMvanVpY2U+XG4gICAgICAgIGp1aWNlOiB0cnVlLFxuICAgICAgICBqdWljZVJlc291cmNlczoge1xuICAgICAgICAgIHByZXNlcnZlSW1wb3J0YW50OiB0cnVlLFxuICAgICAgICAgIHdlYlJlc291cmNlczoge1xuICAgICAgICAgICAgcmVsYXRpdmVUbzogcGF0aC5yZXNvbHZlKCdidWlsZCcpXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAvLyBwYXNzIGEgdHJhbnNwb3J0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IG9yIGEgdHJhbnNwb3J0IGluc3RhbmNlXG4gICAgICAgIC8vIChlLmcuIGFuIGluc3RhbmNlIGlzIGNyZWF0ZWQgdmlhIGBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydGApXG4gICAgICAgIC8vIDxodHRwczovL25vZGVtYWlsZXIuY29tL3RyYW5zcG9ydHMvPlxuICAgICAgICB0cmFuc3BvcnQ6IHt9XG4gICAgICB9LFxuICAgICAgY29uZmlnXG4gICAgKTtcblxuICAgIGlmICghaXNPYmplY3QodGhpcy5jb25maWcudHJhbnNwb3J0KSB8fCBpc0VtcHR5KHRoaXMuY29uZmlnLnRyYW5zcG9ydCkpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUcmFuc3BvcnQgb3B0aW9uIG11c3QgYmUgYSB0cmFuc3BvcnQgaW5zdGFuY2Ugb3IgY29uZmlndXJhdGlvbiBvYmplY3QnXG4gICAgICApO1xuXG4gICAgaWYgKCFpc0Z1bmN0aW9uKHRoaXMuY29uZmlnLnRyYW5zcG9ydC5zZW5kTWFpbCkpXG4gICAgICB0aGlzLmNvbmZpZy50cmFuc3BvcnQgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh0aGlzLmNvbmZpZy50cmFuc3BvcnQpO1xuXG4gICAgZGVidWcoJ3RyYW5zZm9ybWVkIGNvbmZpZyAlTycsIHRoaXMuY29uZmlnKTtcblxuICAgIGF1dG9CaW5kKHRoaXMpO1xuICB9XG5cbiAgLy8gc2hvcnRoYW5kIHVzZSBvZiBganVpY2VSZXNvdXJjZXNgIHdpdGggdGhlIGNvbmZpZ1xuICAvLyAobWFpbmx5IGZvciBjdXN0b20gcmVuZGVycyBsaWtlIGZyb20gYSBkYXRhYmFzZSlcbiAganVpY2VSZXNvdXJjZXMoaHRtbCkge1xuICAgIHJldHVybiBqdWljZVJlc291cmNlcyhodG1sLCB0aGlzLmNvbmZpZy5qdWljZVJlc291cmNlcyk7XG4gIH1cblxuICAvLyBwcm9taXNlIHZlcnNpb24gb2YgY29uc29saWRhdGUncyByZW5kZXJcbiAgLy8gaW5zcGlyZWQgYnkga29hLXZpZXdzIGFuZCByZS11c2VzIHRoZSBzYW1lIGNvbmZpZ1xuICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL3F1ZWNrZXp6L2tvYS12aWV3cz5cbiAgcmVuZGVyKHZpZXcsIGxvY2Fscykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShhc3luYyAocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7IG1hcCwgZW5naW5lU291cmNlLCBleHRlbnNpb24gfSA9IHRoaXMuY29uZmlnLnZpZXdzLm9wdGlvbnM7XG4gICAgICAgIGNvbnN0IHBhdGhzID0gYXdhaXQgZ2V0UGF0aHModGhpcy5jb25maWcudmlld3Mucm9vdCwgdmlldywgZXh0ZW5zaW9uKTtcbiAgICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLnJlc29sdmUodGhpcy5jb25maWcudmlld3Mucm9vdCwgcGF0aHMucmVsKTtcbiAgICAgICAgY29uc3Qgc3VmZml4ID0gcGF0aHMuZXh0O1xuICAgICAgICBpZiAoc3VmZml4ID09PSAnaHRtbCcgJiYgIW1hcCkge1xuICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGVQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIHJlc29sdmUocmVzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBlbmdpbmVOYW1lID0gbWFwICYmIG1hcFtzdWZmaXhdID8gbWFwW3N1ZmZpeF0gOiBzdWZmaXg7XG4gICAgICAgICAgY29uc3QgcmVuZGVyID0gZW5naW5lU291cmNlW2VuZ2luZU5hbWVdO1xuICAgICAgICAgIGlmICghZW5naW5lTmFtZSB8fCAhcmVuZGVyKVxuICAgICAgICAgICAgcmV0dXJuIHJlamVjdChcbiAgICAgICAgICAgICAgbmV3IEVycm9yKGBFbmdpbmUgbm90IGZvdW5kIGZvciB0aGUgXCIuJHtzdWZmaXh9XCIgZmlsZSBleHRlbnNpb25gKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAvLyBUT0RPOiBjb252ZXJ0IHRoaXMgdG8gYSBwcm9taXNlIGJhc2VkIHZlcnNpb25cbiAgICAgICAgICByZW5kZXIoZmlsZVBhdGgsIGxvY2FscywgKGVyciwgcmVzKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyKSByZXR1cm4gcmVqZWN0KGVycik7XG4gICAgICAgICAgICAvLyB0cmFuc2Zvcm0gdGhlIGh0bWwgd2l0aCBqdWljZSB1c2luZyByZW1vdGUgcGF0aHNcbiAgICAgICAgICAgIC8vIGdvb2dsZSBub3cgc3VwcG9ydHMgbWVkaWEgcXVlcmllc1xuICAgICAgICAgICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vZ21haWwvZGVzaWduL3JlZmVyZW5jZS9zdXBwb3J0ZWRfY3NzXG4gICAgICAgICAgICBpZiAoIXRoaXMuY29uZmlnLmp1aWNlKSByZXR1cm4gcmVzb2x2ZShyZXMpO1xuICAgICAgICAgICAgdGhpcy5qdWljZVJlc291cmNlcyhyZXMpXG4gICAgICAgICAgICAgIC50aGVuKHJlc29sdmUpXG4gICAgICAgICAgICAgIC5jYXRjaChyZWplY3QpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBzZW5kKG9wdGlvbnMgPSB7fSkge1xuICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKFxuICAgICAge1xuICAgICAgICB0ZW1wbGF0ZTogJycsXG4gICAgICAgIG1lc3NhZ2U6IHt9LFxuICAgICAgICBsb2NhbHM6IHt9XG4gICAgICB9LFxuICAgICAgb3B0aW9uc1xuICAgICk7XG5cbiAgICBsZXQgeyB0ZW1wbGF0ZSwgbWVzc2FnZSwgbG9jYWxzIH0gPSBvcHRpb25zO1xuXG4gICAgY29uc3QgYXR0YWNobWVudHMgPVxuICAgICAgbWVzc2FnZS5hdHRhY2htZW50cyB8fCB0aGlzLmNvbmZpZy5tZXNzYWdlLmF0dGFjaG1lbnRzIHx8IFtdO1xuXG4gICAgbWVzc2FnZSA9IGRlZmF1bHRzRGVlcChcbiAgICAgIHt9LFxuICAgICAgb21pdCh0aGlzLmNvbmZpZy5tZXNzYWdlLCAnYXR0YWNobWVudHMnKSxcbiAgICAgIG9taXQobWVzc2FnZSwgJ2F0dGFjaG1lbnRzJylcbiAgICApO1xuICAgIGxvY2FscyA9IGRlZmF1bHRzRGVlcCh7fSwgdGhpcy5jb25maWcudmlld3MubG9jYWxzLCBsb2NhbHMpO1xuXG4gICAgaWYgKGF0dGFjaG1lbnRzKSBtZXNzYWdlLmF0dGFjaG1lbnRzID0gYXR0YWNobWVudHM7XG5cbiAgICBkZWJ1ZygndGVtcGxhdGUgJXMnLCB0ZW1wbGF0ZSk7XG4gICAgZGVidWcoJ21lc3NhZ2UgJU8nLCBtZXNzYWdlKTtcbiAgICBkZWJ1ZygnbG9jYWxzIChrZXlzIG9ubHkpOiAlTycsIE9iamVjdC5rZXlzKGxvY2FscykpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChpc09iamVjdCh0aGlzLmNvbmZpZy5pMThuKSkge1xuICAgICAgICAgIGNvbnN0IGkxOG4gPSBuZXcgSTE4TihcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIHRoaXMuY29uZmlnLmkxOG4sIHtcbiAgICAgICAgICAgICAgcmVnaXN0ZXI6IGxvY2Fsc1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gc3VwcG9ydCBgbG9jYWxzLnVzZXIubGFzdF9sb2NhbGVgXG4gICAgICAgICAgLy8gKGUuZy4gZm9yIDxodHRwczovL2xhZC5qcy5vcmc+KVxuICAgICAgICAgIGlmIChpc09iamVjdChsb2NhbHMudXNlcikgJiYgaXNTdHJpbmcobG9jYWxzLnVzZXIubGFzdF9sb2NhbGUpKVxuICAgICAgICAgICAgbG9jYWxzLmxvY2FsZSA9IGxvY2Fscy51c2VyLmxhc3RfbG9jYWxlO1xuXG4gICAgICAgICAgaWYgKGlzU3RyaW5nKGxvY2Fscy5sb2NhbGUpKSBpMThuLnNldExvY2FsZShsb2NhbHMubG9jYWxlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghbWVzc2FnZS5zdWJqZWN0ICYmIHRlbXBsYXRlKVxuICAgICAgICAgIG1lc3NhZ2Uuc3ViamVjdCA9IGF3YWl0IHRoaXMuY29uZmlnLnJlbmRlcihcbiAgICAgICAgICAgIGAke3RlbXBsYXRlfS9zdWJqZWN0YCxcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIGxvY2FscywgeyBwcmV0dHk6IGZhbHNlIH0pXG4gICAgICAgICAgKTtcblxuICAgICAgICBpZiAoIW1lc3NhZ2UuaHRtbCAmJiB0ZW1wbGF0ZSlcbiAgICAgICAgICBtZXNzYWdlLmh0bWwgPSBhd2FpdCB0aGlzLmNvbmZpZy5yZW5kZXIoYCR7dGVtcGxhdGV9L2h0bWxgLCBsb2NhbHMpO1xuXG4gICAgICAgIGlmICghdGhpcy5jb25maWcuaHRtbFRvVGV4dCAmJiAhbWVzc2FnZS50ZXh0ICYmIHRlbXBsYXRlKVxuICAgICAgICAgIG1lc3NhZ2UudGV4dCA9IGF3YWl0IHRoaXMuY29uZmlnLnJlbmRlcihcbiAgICAgICAgICAgIGAke3RlbXBsYXRlfS90ZXh0YCxcbiAgICAgICAgICAgIE9iamVjdC5hc3NpZ24oe30sIGxvY2FscywgeyBwcmV0dHk6IGZhbHNlIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgZWxzZSBpZiAodGhpcy5jb25maWcuaHRtbFRvVGV4dCAmJiBtZXNzYWdlLmh0bWwpXG4gICAgICAgICAgLy8gd2UnZCB1c2Ugbm9kZW1haWxlci1odG1sLXRvLXRleHQgcGx1Z2luXG4gICAgICAgICAgLy8gYnV0IHdlIHJlYWxseSBkb24ndCBuZWVkIHRvIHN1cHBvcnQgY2lkXG4gICAgICAgICAgLy8gPGh0dHBzOi8vZ2l0aHViLmNvbS9hbmRyaXM5L25vZGVtYWlsZXItaHRtbC10by10ZXh0PlxuICAgICAgICAgIG1lc3NhZ2UudGV4dCA9IGh0bWxUb1RleHQuZnJvbVN0cmluZyhcbiAgICAgICAgICAgIG1lc3NhZ2UuaHRtbCxcbiAgICAgICAgICAgIHRoaXMuY29uZmlnLmh0bWxUb1RleHRcbiAgICAgICAgICApO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5wcmV2aWV3KSB7XG4gICAgICAgICAgZGVidWcoJ3VzaW5nIGBwcmV2aWV3LWVtYWlsYCB0byBwcmV2aWV3IGVtYWlsJyk7XG4gICAgICAgICAgYXdhaXQgcHJldmlld0VtYWlsKG1lc3NhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5zZW5kKSB7XG4gICAgICAgICAgZGVidWcoJ3NlbmQgZGlzYWJsZWQgc28gd2UgYXJlIGVuc3VyaW5nIEpTT05UcmFuc3BvcnQnKTtcbiAgICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL25vZGVtYWlsZXIvbm9kZW1haWxlci9pc3N1ZXMvNzk4PlxuICAgICAgICAgIC8vIGlmICh0aGlzLmNvbmZpZy50cmFuc3BvcnQubmFtZSAhPT0gJ0pTT05UcmFuc3BvcnQnKVxuICAgICAgICAgIHRoaXMuY29uZmlnLnRyYW5zcG9ydCA9IG5vZGVtYWlsZXIuY3JlYXRlVHJhbnNwb3J0KHtcbiAgICAgICAgICAgIGpzb25UcmFuc3BvcnQ6IHRydWVcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IHRoaXMuY29uZmlnLnRyYW5zcG9ydC5zZW5kTWFpbChtZXNzYWdlKTtcbiAgICAgICAgZGVidWcoJ21lc3NhZ2Ugc2VudCcpO1xuICAgICAgICByZXNvbHZlKHJlcyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBFbWFpbDtcbiJdfQ==